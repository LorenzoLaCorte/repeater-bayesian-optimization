\documentclass{article}
\usepackage{amsmath}
\usepackage[margin=0.5in]{geometry}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{tikz}
\usepackage{xcolor}
\usepackage{hyperref}
\usepackage{subcaption}

\usetikzlibrary{calc, trees}

\begin{document}

\section*{Notation}

\paragraph*{Tuple Notation}

We represent a protocol distributing entanglement in a chain of $N$ nodes as a tuple
\begin{equation*}
  (PU_0, PU_1, \ldots, PU_{N-2}) \quad \text{with} \quad PU_i = \{s_i, d_i\}
\end{equation*}
representing the operations ($s$ for entanglement swapping and $d$ for distillation) to be performed on the links of the chain, after the initial entanglement generation (which is subsumed as the first operation).
\\\\
Thus, a protocol is a tuple of swaps and distillations, for example:
\begin{equation*}
    (d0, s0, d1, s2, s1)
\end{equation*}
where the first letter represents the operation to be performed, and the following number represents the segment to be distilled or, in the case of a swap, the segment to be swapped with its adjacent right one.

When two links are swapped, the new joined segment is represented by the old right segment index.
\\\\
In the example above, the protocol is composed of 2 distillations and 3 swaps, and it is performed as follows:
\begin{itemize}
    \item $d0$: distillation of segment 0,
    \item $s0$: swap of segments 0 and 1,
    \item $d1$: distillation of the joined segment of 0 and 1 (now represented as segment 1),
    \item $s2$: swap of segments 2 and 3,
    \item $s1$: final swap between the two joined segments 0-1 and 2-3.
\end{itemize}
 
Considering a protocol with $N$ nodes and $S=N-1$ segments, restrictions implied by this notation are:
\begin{enumerate}
  \item a protocol must perform exactly $S$ entanglement swapping operations,
  \item $d\{i\}$ is allowed only if $s\{i\}$ has not been performed yet, otherwise the protocol is invalid.
\end{enumerate}

For example, $(d0, s0, \textcolor{red}{d0}, s2, s1)$ is not valid, as the joined segment 0-1 is represented by $1$ after entanglement swapping has been performed to join the two segments, and so $\textcolor{red}{d0}$ does not have any meaning.

\paragraph*{Binary Tree Notation}

Equivalently to the tuple notation, we can represent a protocol as a binary tree, where the nodes are labeled with a tuple $(i\text{-}j, k)$, where $i$ and $j$ are the extreme indices of the joined segment, and $k$ is the number of distillations performed on it, as shown in Figure \ref{fig:binary_tree_notation}.

\begin{figure}[ht!]
  \centering
  \begin{tikzpicture}[
    level distance=2cm,
    sibling distance=4cm,
    level 2/.style={sibling distance=2cm},
    every node/.style={inner sep=2mm}
  ]
    \node {(0-3, 0)}
        child {node {(0-1, 1)}
            child {node {(0-0, 1)}}
            child {node {(1-1, 0)}}
        }
        child {node {(2-3, 0)}
            child {node {(2-2, 0)}}
            child {node {(3-3, 0)}}
        };
  \end{tikzpicture}
  \caption{Visual representation of the protocol $(d0, s0, d1, s2, s1)$. A protocol can be represented as a binary tree, where the nodes are labeled with a tuple $(i\text{-}j, k)$, where $i$ and $j$ are the extreme indices of the joined segment, and $k$ is the number of distillations performed on it.}
  \label{fig:binary_tree_notation}
\end{figure}

\clearpage
\section*{Heterogeneous Protocols}

We also model protocols with different hardware parameter values for the freshly-generated entanglement pairs.
\\\\
For example, a 4 nodes chain
\begin{equation*}
  \begin{tikzpicture}
    \coordinate (A) at (0, 0);
    \coordinate (B) at (1, 0);
    \coordinate (C) at (3.5, 0);
    \coordinate (D) at (6.5, 0);
  
    \draw (A) -- (B) node[midway, above] {A-B} -- (C) node[midway, above] {B-C} -- (D) node[midway, above] {C-D};
  
    \fill (A) circle (2pt);
    \fill (B) circle (2pt);
    \fill (C) circle (2pt);
    \fill (D) circle (2pt);
  \end{tikzpicture}
\end{equation*}
can have different hardware regimes for its freshly-generated entangled links, for example:
\begin{itemize}
  \item $p_{gen} = 2.6 \cdot 10^{-3}$, $w_0 = 0.9577$ for A-B,
  \item $p_{gen} = 9.2 \cdot 10^{-4}$, $w_0 = 0.9524$ for B-C,
  \item $p_{gen} = 9.1 \cdot 10^{-4}$, $w_0 = 0.9523$ for C-D.
\end{itemize}

Furthermore, we can consider different times of coherence for each node in the chain:
\begin{equation*}
  t_{coh}^A, t_{coh}^B, t_{coh}^C, t_{coh}^D .
\end{equation*}

Then, when performing entanglement swapping between two segments, the joint time of coherence of the memories of the two input links is given by
\begin{equation*}
  ...  
\end{equation*}
which is the ...
\\\\
For example, we can consider coherence times of ...

When performing entanglement swapping between segments A-B and B-C, the joint coherence time will be ...

\section*{Size of the Protocol Space}

The size of the protocol space is given by the number of all possible sequences of operations leading to entanglement distribution of the end-to-end link, considering the restrictions imposed by the notation.
\\\\
The number of valid possible sequences of entanglement swapping operations is given by the number of all the possible binary trees with $N$ leaves, which is given by the number of Catalan numbers of $(N-2)$. As a matter of fact, the nodes in the chain are the leaves of the binary tree, and the tree structure represents the order of the operations to be performed.
Thus, we consider all the possible binary trees with $v = 2(N-1) - 1 = 2S - 1$ vertices.
\\\\
For each valid sequence of SWAPs, we consider all the possible ways of distilling any link at any level of the chain: for each segment, we consider all the possible rounds of distillation $k$ performed on it, from 0 to a maximum $\beta$. 
This means considering, for each binary tree with $v = 2S - 1$ vertices, all the possible values of $k \in [0, \beta]$ for each vertex labeled with $(i\text{-}j, k)$.
\\\\
Thus, considering $N$ nodes, $S$ segments, and a maximum of $\beta$ rounds of distillation per segment, the size of the protocol space is given by:
\begin{equation}
    |P| = C(N-2) \cdot (\beta+1)^v
\end{equation}
where
\begin{equation}
  C(n) = \frac{1}{n+1} \binom{2n}{n}
\end{equation}
is the $n$-th Catalan number.

\clearpage
\section*{Encoding for Bayesian optimization}

The encoding returns a protocol, i.e. a tuple which represents the sequence of operations to be performed to distribute entanglement in the chain.
\\\\
We consider a protocol as a binary tree with $v = 2S - 1$ vertices, as shown in Figure \ref{fig:binary_tree_notation}. From the tree representation, we can derive the tuple representation of the protocol.
\\\\
We consider a maximum of $\beta$ rounds of distillation for each link at any level of the chain, and we encode a protocol by starting from an integer value $\kappa$ and real values $\gamma$, $\eta$ and $\tau$, where:
\begin{itemize}
    \item $\gamma \in [0,1]$ represents the simmetricity of the tree, i.e. how close is the protocol to the most symmetric one,
    \item $\kappa \in [0, \beta]$ is the total rounds of distillations performed on the entangled links at any level of the chain,
    \item $\eta \in [-1, 1]$ and $\tau \in [0,1]$ are used to derive how the $\kappa$ rounds of distillations are distributed among the vertices of the tree.  
\end{itemize}
Considering a protocol with $N=2^n+1$ for an integer $n$, the most symmetric protocol (yielded by \(\gamma=1\)), corresponds to the protocol which can be run by Boxi Li machinery.
For example, for $N=5$, the most symmetric protocol $(s0, s2, s1)$ corresponds to the protocol $(0,0)$.
All the non-symmetric protocols considered cannot be represented in the Boxi Li machinery.
\\\\
First, the set of all possible sequences of swaps $P_{swap}$ is generated, by considering all the possible binary trees with $v = 2S - 1$ vertices. 
They are ordered by the symmetricity of their shape, from the least symmetric to the most symmetric. 
The \((\gamma \times |P_{swap}|\)) tree is selected, so that:
\begin{itemize}
    \item if \(\gamma = 0\), the least symmetric sequence of SWAPs is selected,
    \item if \(\gamma = 1\), the most symmetric sequence of SWAPs is selected.
\end{itemize}
For the selected sequence, we get a shape of a binary tree with $v$ vertices, in which we aim to distribute the $\kappa$ rounds of distillation.
We can visualize the $v$ vertices rounds of distillation as a tuple:
\begin{equation*}
    (\kappa_1, \kappa_2, \ldots, \kappa_v) \quad \text{with} \quad \sum_{i=1}^{v} \kappa_i = \kappa ,
\end{equation*}
where the leftmost values correspond to the rounds of distillation assigned to the leaves of the binary tree, i.e., the freshly-generated segments, whereas the rightmost value correspond to the rounds of distillation assigned to the root of the tree, i.e., the end-to-end link.
\\\\
We can sample the values for this tuple from a normal distribution $\mathcal{N}(\mu, \sigma)$, where
\begin{equation*}
  \mu = \frac{(\eta + 1) \cdot v}{2} \quad \sigma = \tau \cdot v ,
\end{equation*}
and restrict the maximum value of $\kappa_i$ to $\beta$.
\\\\
Thus, the final sequence is selected, so that:
\begin{itemize}
    \item if $\eta = 0$, the sequence which tends to perform the rounds of distillation immediately after generation (link-level) is selected,
    \item if $\eta = 1$, the sequence which tends to perform the rounds of distillation at the end of the protocol (end-to-end level) is selected.
\end{itemize}

\clearpage
\section*{Validation}

\begin{table}[ht!]
  \centering
  \begin{tabular}{|c|c|c|c|}
      \hline
      \multicolumn{2}{|c|}{Bruteforce} & \multicolumn{2}{c|}{Bayesian opt.} \\
      \hline
      Time Taken & Max. SKR & Time Taken & Max. SKR \\
      \hline
      \hline
      105h (exp.) & $0.78 \times 10^{-4}$ & 57m & $0.78 \times 10^{-4}$ \\
      \hline
  \end{tabular}
  \caption{Bruteforce of all the \textbf{asymmetric protocols} and corresponding Bayesian optimization, considering $N=5$ and $\beta=2$, with protocol space size of $|P| = 1.09 \cdot 10^4$. The parameter regime is $p_{gen} = 9.2 \times 10^{-4}$, $w_0 = 0.952$, $t_{coh} = 1.4 \times 10^6$, equivalent to Case C of Table \ref{tab:hardware_regimes}. Bayesian optimization is performed with 10 initial points and a total of 100 shots.}
  \label{tab:validation_regimes}
\end{table}

For the hardware parameters $p_{gen} = 9.2 \times 10^{-4}$, $w_0 = 0.952$, $t_{coh} = 1.4 \times 10^6$, we consider the case of $N=5$ nodes and $\beta=2$ rounds of distillation and present the results of the Bayesian optimization in Figure \ref{fig:gp_validation}.
\\\\
The protocol that maximizes the secret key rate is
  ('d0', 'd0', 'd1', 'd1', 's0', 'd2', 'd2', 'd3', 'd3', 's2', 's1')
which corresponds to the maximally symmetric protocol $(1,1,0,0)$.

\begin{figure}[ht!]
  \centering
  \includegraphics[width=\linewidth, trim=10 10 10 40, clip]{asymmetric/gp5,2/skopt_gp.png}
  \caption{Results of the Bayesian optimization for $N=5$ and $\beta=2$. The algorithm converges to the optimal protocol in less than 100 evaluations, while a bruteforce algorithm must evaluate all the 10935 protocols.}
  \label{fig:gp_validation} 
\end{figure}

\clearpage
\section*{Results}

We present the results of the Bayesian optimization for symmetric and asymmetric protocols, for different hardware regimes and number of nodes.
\\\\
In Table \ref{tab:hardware_regimes}, we present the hardware regimes considered, with the corresponding values of $L_0$, $t_{coh}$, $w_0$, and $p_{gen}$. Values for distance, initial link quality, and generation probability are chosen from the paper of Da Silva \textit{et al.}.
\\\\
In Tables \ref{tab:symmetric_protocols} and \ref{tab:asymmetric_protocols}, we present respectively the results of the Bayesian optimization for symmetric and asymmetric protocols, for different number of nodes and rounds of distillation. For each case, we present the time taken by the bruteforce and the Bayesian optimization algorithms, the maximum secret key rate obtained by both, and the size of the protocol space.

\begin{table}[ht]
    \centering
    \begin{tabular}{|c|c|c|c|c|c|}
        \hline
        Description & $L_0$ (km) & $t_{\text{coh}}$ & $w_0$($F_0$) & $p_{gen}$ \\
        \hline
        \hline
        A: Baseline value, 2 nodes & 200  & $3.6 \times 10^5$ & 0.36 (0.52) & $9.6 \times 10^{-8}$ \\
        \hline
        B: Baseline value, 3 nodes & 100  & $7.2 \times 10^5$ & 0.867 (0.9) & $1.5 \times 10^{-5}$ \\
        \hline
        C: The Hague - Leiden, 5 nodes & 50  & $1.4 \times 10^6$ & 0.952 (0.964) & $9.2 \times 10^{-4}$ \\
        \hline
        D: Delft - The Hague, 11 nodes & 20  & $3.6 \times 10^6$ & 0.958 (0.968) & $2.6 \times 10^{-3}$ \\
        \hline
    \end{tabular}
    \caption{\textbf{Hardware Regimes} considered for the simulations. $L_0$ is the distance between the nodes of the chain, $w_0$ is the quality of a freshly-generated link, and $p_{gen}$ is the probability of successful generation of an entangled pairs at link level. $t_{coh}$ is the joint coherence time of the memories of the nodes, given in units of time of the simulation.}
    \label{tab:hardware_regimes}
\end{table}

\begin{table}[ht]
    \centering
    \begin{tabular}{|c|c|c|c|c|c|}
        \hline
        & BF time & BF Results & GP time & GP result & $|P|$ \\
        \hline
        \hline
        B & 2h 32m & 0.0 & 19min & 0.0 & 21 \\
        & & (no best) & & (no best) & \\
        \hline
        C & 17min & $0.78 \times 10^{-4}$ & 6min & $0.78 \times 10^{-4}$ & 56 \\
        & & (1,1,0,0) & & $(1,1,0,0)$ & \\
        \hline
    \end{tabular}
    \caption{\textbf{Symmetric Protocols}, involving different values for $N$, depending on the row, and up to 5 rounds of distillation. All the simulations have been run on the Deigo cluster. Bayesian optimizations are performed with 2 initial points and a total of 20 shots.}
    \label{tab:symmetric_protocols}
\end{table}

\begin{table}[ht]
    \centering
    \begin{tabular}{|c|c|c|c|c|c|}
        \hline
        & BF time & BF Results & GP time & GP result & $|P|$ \\
        \hline
        \hline
        A & 7m & 0.0 & - & - & 2 \\
        \hline
        B & 8m & 0.0 & - & - & 8 \\
        \hline
        C & 3.5h & $0.74 \times 10^{-4}$ & ... & ... & 640 \\
        \hline
        D & - & - & 3.5h & $0.53 \times 10^{-4}$ & $2.54 \times 10^9$ \\
        \hline
    \end{tabular}
    \caption{\textbf{Asymmetric Protocols} results. For all the cases we allowed $\beta=1$ possible rounds of distillation for each segment. All the simulations have been run on the Deigo cluster. Bayesian optimizations are performed with 10 initial points and a total of 100 shots.}
    \label{tab:asymmetric_protocols}
\end{table}

We present Case C of Table \ref{tab:symmetric_protocols} in Figure \ref{fig:symmetric_5_nodes}. The protocol that maximizes the secret key rate is $(1,1,0,0)$, a result which is consistent with the bruteforce algorithm and with the results of the validation presented in Table \ref{tab:validation_regimes}.
\\\\
We also present Case D of Table \ref{tab:asymmetric_protocols} in Figure \ref{fig:asymmetric_11_nodes}. The protocol that maximizes the secret key rate is 
\begin{equation*}
  \text{('d0', 'd1', 's0', 'd2', 'd3', 's2', 'd1', 'd3', 's1', 'd4', 'd5', 's4', 'd3', 'd5', 's3', 'd6', 'd7', 's6', 'd8', 'd9', 's8', 'd7', 'd9', 's7', 'd5', 'd9', 's5')} . 
\end{equation*}


\begin{figure}[ht!]
  \centering
  \includegraphics[width=\linewidth, trim = 10 10 10 50, clip]{symmetric/results_gp_centerspace/skopt_gp.png}
  \caption{Results of the GP optimization for 5 nodes (2 symmetric swaps), and up to 5 rounds of distillation (applied to all links in the level). The algorithm converges to the optimal protocol in less than 20 evaluations, while a bruteforce algorithm must evaluate 56 protocols.}
  \label{fig:symmetric_5_nodes}
\end{figure}

\begin{figure}[ht!]
  \centering
  \includegraphics[width=\linewidth, trim = 10 10 10 50, clip]{asymmetric/gp11,1/skopt_gp.png}
  \caption{Results of the GP optimization for 11 nodes (asymmetric protocol), and up to 1 round of distillation for each link at any level.}
  \label{fig:asymmetric_11_nodes}
\end{figure}

\end{document}
